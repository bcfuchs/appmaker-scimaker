<polymer-element name="ceci-thingspeak" attributes="volume playsound fontsize textcolor buttoncolor label value" label="Send to THingspeak" value="Press" extends="ceci-element"
  textcolor="#ffffff"
  fontsize="18"
  volume=".5"
  playsound="true"
  buttoncolor="orange">
  <ceci-definition>
    {
      "tags": ["button", "click", "tap"],
      "thumbnail": "./thumbnail.png",
      "description": "Send data to thingspeak",
      "name": "Thingspeak",
      "broadcasts": {
        "click": {
          "label": "Press",
          "description": "Occurs when button is clicked.",
          "default": true
        }
      },
      "listeners": {
        "field0": {
           "label":"field0",
           "description":"field0"
    },
        "field1": {
           "label":"field1",
           "description":"field1"
    },
        "field2": {
           "label":"field2",
           "description":"field2"
    },
        "field3": {
           "label":"field3",
           "description":"field3"
    },
        "sendData": {
           "label":"sendData",
           "description":"sendData"
          
    }

      },
      "attributes": {
        "apikey": {
          "label": "API Key",
          "description": "Your Thingspeak API key. Get one at https://thingspeak.com/",
          "editable": "text",
          "listener": true
        },
        "label": {
          "label": "Label",
          "description": "Text shown on the button.",
          "editable": "text",
          "default": "Send to thingspeak",
          "listener": true
        },
        "value": {
          "label": "Broadcast Value",
          "description": "Value sent by the button.",
          "editable": "text"
        },
        "textcolor": {
          "label": "Text Color",
          "description": "Color of the text on the button's label.",
          "editable": "color"
        },
        "buttoncolor": {
          "label": "Button Color",
          "description": "Background color of the button.",
          "editable": "color",
          "listener": true
        },
        "fontsize": {
          "label": "Font Size",
          "description": "Button label font size.",
          "editable": "range",
          "min" : "4",
          "max" : "40"
        },
        "playsound": {
          "label": "Play Sound when Pressed",
          "description": "Play a sound when pressed.",
          "editable": "boolean"
        },
        "volume": {
          "label": "Volume",
          "editable": "range",
          "min" : 0,
          "max" : 1,
          "step" : ".01"
        }
      }
    }
  </ceci-definition>
  <template>
    <link rel="stylesheet" href="component.css"></link>
    <div id="buttonwrapper" style="font-size: {{fontsize}}px; background: {{buttoncolor}};" on-ceci-pressdown="{{pressdown}}" on-ceci-pressup="{{pressup}}" class="button-wrapper">
      &nbsp;
      <div class="overlay active-overlay"></div>
      <div id="button" style="color: {{textcolor}};">{{label}}</div>
      <div class="bottom"></div>
    </div>
    <shadow></shadow>
    <!-- Button click sound courtesy of http://www.freesfx.co.uk -->
  </template>
  <script>
/**
Plan 
In<-fields on channels
Out->call to thingspeak
data: your apikey. 
*/

    Polymer('ceci-thingspeak', {
      setGeo : function(cb) {
        this.super();
        console.log("->setGeo");
        /* http://www.html5rocks.com/en/tutorials/geolocation/trip_meter/ */

        // geo stuff
        var that = this;

        // make a collection
        // note addCollection should return a collection but doesnt

        var collections = document.querySelector("ceci-collections");
        var geo;

        // getCollection throws undefined function if collection isn't there!
        try {
          geo = collections.getCollection("geo");
        } catch (e) {
          console.error(e);
        }

        // make geo if it's not there.
        // exc: it's been created by another component--we really need a system service here!
        if (!geo) {
          console.log("adding geo");
          collections.addCollection('geo')
          geo = collections.getCollection("geo");
        }
        

        // add fields
        geo.addField("lat");
        geo.addField("lon");

        // get geo and add cell data
		console.log("about to get geodata");
        window.navigator.geolocation.getCurrentPosition(function(pos) {
          var lat, lon;

          // exc. if undefined? prob just leave, let caller cope, push error
          lat = pos.coords.latitude
          lon = pos.coords.longitude;
	    	console.log("latlon: " + lat + " " + lon);
          //    that.broadcast('lat',pos.coords.latitude);
          //    that.broadcast('lon',pos.coords.longitude);

          // add cell data

          geo.addItem({
            "lat" : lat,
            "lon" : lon
          });
          this.$.lat = lat;
          this.$.lon = lon;
          geo.saveData();
        
	      cb({"lat":lat,"lon":lon});
        });
      }, //setGeo
      getGeo : function() {
          this.super();
          // Do the geo stuff when element is inserted. 
          // get the geo information
          console.log("getting geo info in thingspeak 2");
          var collections = document.querySelector("ceci-collections");
          // probably we should set the name of the collection in appdata. 
          var geo = collections.getCollection("geo");
          console.log(geo);
          var lat = geo.getData()[0].lat;
          var lon = geo.getData()[0].lon;
          console.log("lat : " + lat);
          console.log("lon : " + lon);
          this.$.lat = lat;
          this.$.lon = lon;
        },

        ready : function() {
          this.super();
          this.loadSound("tap", "sounds/tap.mp3");

        },
        attached : function() {
          this.super();
          var that = this;
          this.setGeo(function(){that.getGeo();});
        },
        pressdown : function() {
          this.super();
          if (this.playsound === "true") {
            this.playSound("tap", this.volume);
          }
          this.$.buttonwrapper.classList.add("pressdown");
          this.broadcast('click', this.getAttribute('value'));
        },
        pressup : function() {
          this.$.buttonwrapper.classList.remove("pressdown");
          this.$.buttonwrapper.classList.remove("fade");
          this.$.buttonwrapper.offsetWidth = this.$.buttonwrapper.offsetWidth;
          this.$.buttonwrapper.classList.add("fade");
        },
        sendData : function() {
          console.log("sendData");
         
          this.submit();
        },
        field0 : function(e) {
          this.$.field0 = e;
          

        },
        // various components set data at ready
        // user clicks here or a separate button to submit
        submit : function() {
          console.log("thingspeak: submit");
          var that = this;
        var send2ts = function(geo) {
       // instructions: 
       // create the first two fields for thingspeak as lat lon
          
         /*  var field1 = this.$.field1.value;
          var field2 = this.$.field2.value;
          var field3 = this.$.field3.value; */
          //TODO -- this could be used to inject code!
          var apikey = that.attributes.apikey.value;
          console.log("send2ts");
          var url = 'http://api.thingspeak.com/update?key='+apikey;
          url = url + '&field1='+ encodeURIComponent(that.$.field0) + "&field3="+geo.lat+"&field4="+geo.lon;
	      console.log(url);
          $.ajax(url);
        }
         
          this.setGeo(function(geo){send2ts(geo)});
          
        }
      });
    </script>
</polymer-element>
